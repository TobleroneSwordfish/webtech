<!DOCTYPE html>
<html lang="en-GB">
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<meta charset="UTF-8">
<title>Planetside 2 stats</title>
</head>
<body style="background-color: rgb(70, 70, 70); color:#fff">
<ul class="navbar horizontal">
<li><a href="/">Home</a></li>
<li><a href="/fanart">Fanart</a></li>
<li><a href="/about.html">About</a></li>
</ul>
<div style="overflow: hidden; height: 20%;">
<div class="container horizontal" style="width: 60%; height: 100%; float:left; margin-left: 20%;">
<div class="container logo" style="transform-origin: top left; height: 100%;"><img src="/VSlogo.svg" class="logo-img center" alt="#########">
<div class="top-left faction-info hidden">teeeeeeeext</div>
</div>
<div class="container logo" style="transform-origin: top center; height: 100%"><img src="/NClogo.svg" class="logo-img center" alt="#########"></div>
<div class="container logo" style="transform-origin: top right; height: 100%"><img src="/TRlogo.svg" class="logo-img center" alt="#########"></div>
</div>
<div style="float:right; width: 18%; height: 90%; border: 4px solid rgb(76, 15, 133);">
<div style="border-bottom: 2px solid blue; text-align: center; overflow:auto;" id="notifications">NOTIFICATIONS</div>
</div>
</div>
<script>
  "use strict"
  addEventListener("load", setup);
  var logos;
  function setup() {
    logos = Array.from(document.querySelectorAll(".logo"));
    for (var i = 0; i < logos.length; i++) {
      logos[i].addEventListener("click",  expand);
      logos[i].addEventListener("animationend", animEnd);
    }
  }
  //adds or removes the "hidden" class on child objects of node that have class objClass according to state
  function toggleHidden(node, objClass, state) {
    var nodes = node.getElementsByClassName(objClass)
    if (nodes != null) {
      for (var i = 0; i < nodes.length; i++) {
        if (state) {
          nodes[i].classList.add("hidden")
        }
        else {
          nodes[i].classList.remove("hidden")
        }
      }
    }
  }

  //make sure no other logo is expanded or currently animating
  const checkActive = (logo) => !logo.classList.contains("expand") && !logo.classList.contains("contract") && !logo.classList.contains("expanded")
  //expands
  function expand(event) {
    if (this.classList.contains("expanded")) { //is already expanded
      this.classList.remove("expanded");
      this.classList.add("contract"); //start contracting
    } 
    
    else if (logos.every(checkActive)) {
      for (var i = 0; i < logos.length; i++) {
        if (logos[i].classList.contains("expanded") || logos[i].classList.contains("expand")) {
          logos[i].classList.remove("expanded");
          logos[i].classList.remove("expand");
          logos[i].classList.add("contract");
        }
      }
      toggleHidden(this, "faction-info", false)
      this.classList.add("expand");
    }
  }

  function animEnd(event) {
    console.log(event);
    if (this.classList.contains("contract")) {
      this.classList.remove("contract");
      toggleHidden(this, "faction-info", true)
    }
    if (this.classList.contains("expand")) {
      this.classList.remove("expand");
      this.classList.add("expanded");
    }
  }
</script>
<div>
<p id="info"></p>
</div>
<script>
  "use strict"
  var flag = "inc";
  const colnames = {
    username: 0,
    resurrections: 1,
    suicides: 2,
    teamkills: 3,
    times_revived: 4
  }
  fetch("/api/").then(handleRessurections);
  function handleRessurections(response) {
    response.text().then(fillRessurections)
  }
  function fillRessurections(data) {
    console.log("response is")
    console.log(data)
    document.body.querySelector("#info").innerHTML = stringToTable(data);
    document.getElementById("res").addEventListener('click', function(){
      if (flag == "inc"){
        sort("playerstats", "res", "dec");
        flag="dec"
      }
      else {
        sort("playerstats", "res", "inc");
        flag ="inc"
      }
    })
    document.getElementById("name").addEventListener('click', function(){
      sort("playerstats", "name","inc");
    })
  }

  function stringToTable(data) {
    var array = parse(data);
    console.log("Array is")
    console.log(array)
    var perrow = 5
    html = "<table id = playerstats ><tr>";
    html += "<td id = name> Username </td>";
    html += "<td id = res> # of resurrections </td>";
    html += "<td id = res> # of suicides </td>";
    html += "<td id = res> # of teamkills </td>";
    html += "<td id = res> # of times_revived </td>";
    html += "</tr> <tr>";  
    for (var i=0; i<array.length; i++) {
      html += "<td id = c"+ i +"r" + i%perrow + " >" + array[i] + "<\/td>";
      if ((i+1)%perrow==0 && (i+1)!=array.length) {
        html += "<\/tr><tr>";
      }
    }
    html += "<\/tr><\/table>";
    return html;
  }

  function sort(tableid, sortid, iord){
    id = colnames[sortid];
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById(tableid);
    switching = true;
    while (switching) {
      switching = false;
      rows = table.rows;
      for (i = 1; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        x = rows[i].childNodes[id]
        y = rows[i+1].childNodes[id]
        if (iord == "inc"){
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          shouldSwitch = true;
          break;
          }
        }
        else {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          shouldSwitch = true;
          break;
         }
        }
        
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }

  function parse(str){
    str=str.split(" ").join("");
    console.log(str);
    str=str.split("(").join("");
    console.log(str);
    str=str.split(")").join("");
    console.log(str);
    console.log(str);
    return str.split(",");
  }
</script>
<script>
  "use strict"
  let notification_socket = new WebSocket("ws://" + window.location.hostname + ":8080/notifications");
  notification_socket.onmessage = handle_notifications;
  // notification_socket.onopen = open_notification_socket();
  function handle_notifications(response){
    // console.log(response);
    fill_notifications(JSON.parse(response.data));
  }
  function fill_notifications(data) {
    // console.log(data.text)
    var box = document.body.querySelector("#notifications");
    var newElement = document.createElement("div");
    newElement.innerText = data.text;
    box.appendChild(newElement);
  }
</script> 
</body>
</html>
