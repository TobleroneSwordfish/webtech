<!DOCTYPE html>
<html lang="en-GB">
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<meta charset="UTF-8">
<title>Planetside 2 stats</title>
</head>
<body>
<ul class="navbar horizontal">
<li><a href="/">Home</a></li>
<li><a href="/fanart">Fanart</a></li>
<li>
$if(loggedin){
  <a href="/logout">Logged in as ${username}</a>
}else{
  <a href="/login">Login</a>
}
</li>
</ul>
<div class="dark">
<div class = "top">
<div class = "container">
<div class="logo logo-left"><img src="/VSlogo.svg" class="logo-img center" alt="Aliens">
<div class="faction-info hidden">aaaaaaaaaaaaaaaa fuckity fuck fuck fuck</div>
</div>
<div class="logo logo-center"><img src="/NClogo.svg" class="logo-img center" alt="Muricans"></div>
<div class="logo logo-right"><img src="/TRlogo.svg" class="logo-img center" alt="The Bad Guys"></div>
</div>
</div>
<br>
<div class = "box">
  <div class = "box-title">NOTIFICATIONS</div>
  <div class = "box-content" id="notifications"></div>
</div>
<select id="count" name="# of players">
  <option value="10" selected>10</option>
  <option value="20">20</option>
  <option value="50">50</option>
  <option value="100">100</option>
</select>
<div id="info">
  <table id = playerstats><thead><tr>
  <th>Index</th>
  <th id = username class="wide" > Username </th>
  <th id = resurrections> # of resurrections </th>
  <th id = suicides> # of suicides </th>
  <th id = teamkills> # of teamkills </th>
  <th id = times_revived> # of times_revived </th> 
  <th id = faction_id> Faction ID </th> 
</tr></thead></table>
</div>
</div>
<script>
  "use strict"
  addEventListener("load", setup);
  var logos;
  function setup() {
    logos = Array.from(document.querySelectorAll(".logo"));
    for (var i = 0; i < logos.length; i++) {
      logos[i].addEventListener("click",  expand);
      logos[i].addEventListener("animationend", animEnd);
    }
  }
  
  //adds or removes the "hidden" class on child objects of node that have class objClass according to state
  function toggleHidden(node, objClass, state) {
    var nodes = node.getElementsByClassName(objClass)
    if (nodes != null) {
      for (var i = 0; i < nodes.length; i++) {
        if (state) {
          nodes[i].classList.add("hidden")
        }
        else {
          nodes[i].classList.remove("hidden")
        }
      }
    }
  }

  function getSide(obj) {
    if (obj.classList.contains("logo-left")) {
      return ["expand-left", "expanded-left","contract-left"];
    }
    else if (obj.classList.contains("logo-center")) {
      return ["expand-center","expanded-center","contract-center"];
    }
    else if (obj.classList.contains("logo-right")) {
      return ["expand-right","expanded-right","contract-right"];
    }
  }

  //expands
  function expand(event) {
    var tags = getSide(this);
    var expandTag = tags[0];
    var expandedTag = tags[1]
    var contractTag = tags[2];
    console.log(tags);
    //make sure no other logo is expanded or currently animating
    const checkActive = (logo) => !logo.classList.contains(expandTag) && !logo.classList.contains(contractTag) && !logo.classList.contains(expandedTag)

    if (this.classList.contains(expandedTag)) { //is already expanded
      this.classList.remove(expandedTag);
      this.classList.add(contractTag); //start contracting
    } 
    
    else if (logos.every(checkActive)) {
      for (var i = 0; i < logos.length; i++) {
        if (logos[i].classList.contains(expandedTag) || logos[i].classList.contains(expandTag)) {
          logos[i].classList.remove(expandedTag);
          logos[i].classList.remove(expandTag);
          logos[i].classList.add(contractTag);
        }
      }
      toggleHidden(this, "faction-info", false)
      this.classList.add(expandTag);
      this.classList.add("expanding");
    }
  }

  function animEnd(event) {
    var tags = getSide(this);
    var expandTag = tags[0];
    var expandedTag = tags[1]
    var contractTag = tags[2];
    // console.log(event);
    if (this.classList.contains(contractTag)) {
      this.classList.remove(contractTag);
      this.classList.remove("expanding");
      toggleHidden(this, "faction-info", true)
    }
    if (this.classList.contains(expandTag)) {
      this.classList.remove(expandTag);
      this.classList.add(expandedTag);
    }
  }
  
  const colnames = {
    username: 0,
    resurrections: 1,
    suicides: 2,
    teamkills: 3,
    times_revived: 4,
    faction_id: 5
  }
  var selectedid="resurrections";
  var count=10;
  for (let id in colnames){
      console.log(id)
      document.getElementById(id).addEventListener('click', function(){
        selectedid=id;
        fetch("/api/" + selectedid + "?count=" + count + "&iod=dec").then(handleTable);
      })
    }
  var dropdown = document.getElementById("count");
  dropdown.addEventListener('change', function(){
    count=dropdown.options[dropdown.selectedIndex].value;
    fetch("/api/" + selectedid + "?count=" + dropdown.options[dropdown.selectedIndex].value+ "&iod=dec").then(handleTable);
  })
  fetch("/api/").then(handleTable);
  function handleTable(response) {
    console.log("hello")
    response.text().then(fillTable)
  }
  function fillTable(data) {
    resetTable();
    console.log(data)
    document.getElementById(selectedid).classList.add("selected");
    data = data.split("null").join(0)
    var obj = JSON.parse(data);
    var table = document.getElementById("playerstats");
    table.appendChild(document.createElement('tbody'));
    var table = document.getElementById("playerstats").getElementsByTagName("tbody")[0];
    for (var u in obj){
      console.log(u)
      var row = table.insertRow(-1);
      var cell = row.insertCell(-1);
      cell.innerHTML = parseInt(u)+1;
      for (var p in colnames){
        var cell = row.insertCell(-1);
        cell.innerHTML = obj[u][p];
        if (p==selectedid){
          cell.classList.add("selected");
        }
      }
    }
  }
  function resetTable(){
    var length = document.getElementById("playerstats").rows.length;
    for (var i=1; i<length; i++){
      console.log(i)
      document.getElementById("playerstats").deleteRow(1);
    }
  }

  function sort(tableid, sortid, iord){
    // console.log(sortid)
    var id = colnames[sortid];
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById(tableid);
    switching = true;
    while (switching) {
      switching = false;
      rows = table.rows;
      for (i = 1; i < (rows.length - 2); i++) {
        shouldSwitch = false;
        // console.log(rows[i])
        x = rows[i].childNodes[id]
        y = rows[i+1].childNodes[id]
        if (iord == "inc"){
          if (parseInt(x.innerHTML.toLowerCase()) > parseInt(y.innerHTML.toLowerCase())) {
          shouldSwitch = true;
          break;
          }
        }
        else {
          if (parseInt(x.innerHTML.toLowerCase()) < parseInt(y.innerHTML.toLowerCase())) {
          shouldSwitch = true;
          break;
         }
        }
        
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }

  function parse(str){
    str=str.split(" ").join("");
    // console.log(str);
    str=str.split("(").join("");
    // console.log(str);
    str=str.split(")").join("");
    // console.log(str);
    return str.split(",");
  }
</script>
<script>
  "use strict"
  let notification_socket = new WebSocket("ws://" + window.location.hostname + ":8080/notifications");
  notification_socket.onmessage = handle_notifications;
  // notification_socket.onopen = open_notification_socket();
  function handle_notifications(response){
    fill_notifications(JSON.parse(response.data));
  }
  function fill_notifications(data) {
    var box = document.body.querySelector("#notifications");
    // var newElement = document.createElement("div");
    // newElement.innerText = data.text;
    box.innerHTML=data.text;
  }
</script>
<a id="tidy_logo" href="http://users.skynet.be/mgueury/mozilla/">
  <img src="http://users.skynet.be/mgueury/mozilla/tidy_32.gif"
  alt="Validated by HTML Validator (based on Tidy) " height="32" width="78"/>
</a>
</body>
</html>
