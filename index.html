<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
  lang="en-GB" xml:lang="en-GB">
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<meta charset="UTF-8"/>
<title>we need a title</title>
</head>
<body>
<ul class="navbar horizontal">
  <li><a href="/">Home</a></li>
  <li><a href="/datapage.html">Data page</a></li>
  <li><a href="/about.html">About</a></li>
</ul>
<div class="container horizontal" style="width: 60%; margin-left: 20%;">
  <div class="container logo" style="transform-origin: top left;">
    <img src="/VSlogo.svg" class="logo-img">
    <div class="top-left faction-info hidden">teeeeeeeext</div>
  </div>
  <div class="container logo" style="transform-origin: top center;">
    <img src="/NClogo.svg" class="logo-img">
  </div>
  <div class="container logo" style="transform-origin: top right;">
    <img src="/TRlogo.svg" class="logo-img">
  </div>
</div>
<script>
  "use strict"
  addEventListener("load", setup);
  var logos;
  function setup() {
    logos = Array.from(document.querySelectorAll(".logo"));
    for (var i = 0; i < logos.length; i++) {
      logos[i].addEventListener("click",  expand);
      logos[i].addEventListener("animationend", animEnd);
    }
  }
  //adds or removes the "hidden" class on child objects of node that have class objClass according to state
  function toggleHidden(node, objClass, state) {
    var nodes = node.getElementsByClassName(objClass)
    if (nodes != null) {
      for (var i = 0; i < nodes.length; i++) {
        if (state) {
          nodes[i].classList.add("hidden")
        }
        else {
          nodes[i].classList.remove("hidden")
        }
      }
    }
  }

  //make sure no other logo is expanded or currently animating
  const checkActive = (logo) => !logo.classList.contains("expand") && !logo.classList.contains("contract") && !logo.classList.contains("expanded")
  //expands
  function expand(event) {
    if (this.classList.contains("expanded")) { //is already expanded
      this.classList.remove("expanded");
      this.classList.add("contract"); //start contracting
    } 
    
    else if (logos.every(checkActive)) {
      for (var i = 0; i < logos.length; i++) {
        if (logos[i].classList.contains("expanded") || logos[i].classList.contains("expand")) {
          logos[i].classList.remove("expanded");
          logos[i].classList.remove("expand");
          logos[i].classList.add("contract");
        }
      }
      toggleHidden(this, "faction-info", false)
      this.classList.add("expand");
    }
  }

  function animEnd(event) {
    console.log(event);
    if (this.classList.contains("contract")) {
      this.classList.remove("contract");
      toggleHidden(this, "faction-info", true)
    }
    if (this.classList.contains("expand")) {
      this.classList.remove("expand");
      this.classList.add("expanded");
    }
  }
</script>
<h1>hmm yes</h1>
<p>The current time and date is ${time}</p>

<p id=resurrections></p>
<script>
  var flag = "inc";
  const colnames = {
      name: 0,
      res: 1
  }

  "use strict"
  fetch("/?res=yes").then(handleRessurections);
  function handleRessurections(response) {
    console.log(response)
    response.text().then(fillRessurections)
  }
  function fillRessurections(data) {
    document.body.querySelector("#resurrections").innerHTML = stringToTable(data);
    document.getElementById("res").addEventListener('click', function(){
      if (flag == "inc"){
        sort("playerstats", "res", "dec");
        flag="dec"
      }
      else {
        sort("playerstats", "res", "inc");
        flag ="inc"
      }
    })
    document.getElementById("name").addEventListener('click', function(){
      sort("playerstats", "name","inc");
    })
  }

  function stringToTable(data) {
    var array = parse(data);
    var perrow = 2, // 3 cells per row
    html = "<table id = playerstats ><tr>";
    html += "<td id = name> Username </td>";
    html += "<td id = res> # of resurrections </td> </tr> <tr>";  
    for (var i=0; i<array.length; i++) {
      html += "<td id = c"+ i +"r" + i%perrow + " >" + array[i] + "</td>";
      if ((i+1)%perrow==0 && (i+1)!=array.length) {
        html += "</tr><tr>";
      }
    }
    html += "</tr></table>";
    return html;
  }

  function sort(tableid, sortid, iord){
    id = colnames[sortid];
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById(tableid);
    switching = true;
    while (switching) {
      switching = false;
      rows = table.rows;
      for (i = 1; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        x = rows[i].childNodes[id]
        y = rows[i+1].childNodes[id]
        if (iord == "inc"){
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          shouldSwitch = true;
          break;
          }
        }
        else {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          shouldSwitch = true;
          break;
         }
        }
        
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }

  function parse(str){
    console.log(str);
    str=str.split(" ").join("");
    console.log(str);
    str=str.split("(").join("");
    console.log(str);
    str=str.split(")").join("");
    console.log(str);
    console.log(str);
    return str.split(",");
  }
</script> 


<p id="jsondump"></p>
<p>
  Overall HSR:
  <div id="HSR"></div>
</p>
<p>
  Infantry only HSR:
  <div id="infantryHSR"></div>
</p>
<script>
  "use strict"
  fetch("http://census.daybreakgames.com/s:jtwebtech/get/ps2/character").then(handle);
  function handle(response) {
    response.json().then(fill)
  }
  function fill(data) {
    document.body.querySelector("#jsondump").innerHTML = JSON.stringify(data);
  }
</script>

<script>
  "use strict"
  var serviceID = "s:jtwebtech"
  let socket = new WebSocket("wss://push.planetside2.com/streaming?environment=ps2&service-id=" + serviceID);
  socket.onmessage = handle;
  socket.onopen = start;

  var msgCount = 0;
  var killCount = 0;
  var headshots = 0;
  var infantryKills = 0;
  var infantryHeadshots = 0;

  var factions = ["", "Vanu Sovereignty", "New Conglomerate", "Terran Republic"];

  function handle(event) {
    //console.log(event.data);
    msgCount++;
    var jsonData = JSON.parse(event.data);
    console.log(jsonData);
    //ignore heartbeat messages
    if (jsonData.type == "heartbeat") {
      return
    }
    else if (jsonData.type == "serviceMessage") { //all useful data comes via service messages
      if (jsonData.payload.event_name == "Death") { //someone dieded
        killCount++;
        if (jsonData.payload.attacker_vehicle_id == 0) { //the attacker was not in a vehicle
          infantryKills++;
        }
        if (jsonData.payload.is_headshot == 1) { //it was a headshot
          headshots++;
          if (jsonData.payload.attacker_vehicle_id == 0) { //the attacker was not in a vehicle
            infantryHeadshots++;
          }
        }
        document.body.querySelector("#HSR").innerHTML = headshots / killCount;
        document.body.querySelector("#infantryHSR").innerHTML = infantryHeadshots / infantryKills;
      }
      else if (jsonData.payload.event_name == "FacilityControl") {
        getFacility(jsonData);
      }
    }
  }

  function getFacility(jsonData) {
    var url = "http://census.daybreakgames.com/" + serviceID +"/get/ps2:v2/map_region/?facility_id=" + jsonData.payload.facility_id;
    console.log(url);
    fetch(url).then((response) => printFacility(response, jsonData.payload.new_faction_id))
  }
  function printFacility(response, faction_id) {
    response.json().then((json) => {
      var data = json.map_region_list[0];
      console.log(data.facility_name + " " + data.facility_type + " was captured by faction " + factions[faction_id]);
    });
  }

  function start(e) {
    //subscribe to all death events from world ID 1 (connery server)
    var deathJSON = {
	    "service":"event",
      "action":"subscribe",
      "characters":["all"],
      "worlds":["1"],
      "eventNames":["Death"]
    }
    var controlJSON = {
	    "service":"event",
      "action":"subscribe",
      "characters":["all"],
      "worlds":["all"],
      "eventNames":["FacilityControl"]
    }
    var revive=1;
    socket.send(JSON.stringify({ "service": "event", "action": "subscribe", "characters": ["all"], "eventNames": ["GainExperience_experience_id_7"] }));
  }
</script>
</body>
</html>